<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý Dịch vụ</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    input, textarea, select { width: 100%; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Quản lý Dịch vụ HTTP</h1>

  <form id="serviceForm">
    <input type="text" placeholder="Tên dịch vụ" name="name" required />
    <input type="text" placeholder="URL" name="url" required />
    <select name="method">
      <option value="GET">GET</option>
      <option value="POST">POST</option>
    </select>
    <input type="text" id="schedule_time" name="schedule_time">
    <textarea name="data" placeholder="POST data (JSON)"></textarea>
    <textarea name="cookies" placeholder="Cookies (JSON)"></textarea>
    <input type="number" name="timeout" placeholder="Timeout (giây)" value="5" />
    <button type="submit">Thêm / Cập nhật dịch vụ</button>
  </form>

  <h2>Danh sách dịch vụ</h2>
  <table id="servicesTable">
    <thead>
      <tr>
        <th>Tên</th><th>URL</th><th>Method</th><th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let services = [];
    let editId = null;

    async function fetchServices() {
      const res = await fetch("/api/services");
      services = await res.json();
      renderServices();
    }

    function renderServices() {
      const tbody = document.querySelector("#servicesTable tbody");
      tbody.innerHTML = "";

      services.forEach((s) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${s.name}</td>
          <td>${s.url}</td>
          <td>${s.method}</td>
          <td>
            <button onclick="editService(${s.id})">Sửa</button>
            <button onclick="deleteService(${s.id})">Xoá</button>
            <button onclick="checkService(${s.id})">Kiểm tra</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById("serviceForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      const data = {
        name: form.name.value,
        url: form.url.value,
        method: form.method.value,
        data: tryParse(form.data.value),
        cookies: tryParse(form.cookies.value),
        schedule_time: form.schedule_time.value,
        timeout: parseInt(form.timeout.value || "5")
      };

      const method = editId ? "PUT" : "POST";
      const url = editId
        ? `/api/services/${editId}`
        : "/api/services";

      await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      editId = null;
      form.reset();
      fetchServices();
    });

    function tryParse(json) {
      try {
        return json ? JSON.parse(json) : {};
      } catch {
        return {};
      }
    }

    async function deleteService(id) {
      if (!confirm("Bạn có chắc chắn muốn xoá dịch vụ này?")) return;
      await fetch(`/api/services/${id}`, { method: "DELETE" });
      fetchServices();
    }


    function editService(id) {
      const s = services.find((x) => x.id === id);
      const form = document.getElementById("serviceForm");

      form.name.value = s.name;
      form.url.value = s.url;
      form.method.value = s.method;
      form.data.value = JSON.stringify(s.data || {}, null, 2);
      form.cookies.value = JSON.stringify(s.cookies || {}, null, 2);
      form.schedule_time.value = s.cron
      form.timeout.value = 5;

      editId = s.id;
    }

    async function checkService(id) {
      const res = await fetch(`/api/services/${id}/check`);
      const result = await res.json();

      alert(
        `Tên dịch vụ: ${result.name}\n` +
        `Trạng thái: ${result.status}\n` +
        `Mã: ${result.status_code || "N/A"}\n` +
        `Phản hồi: ${result.response_time || "?"}ms\n` +
        `Lỗi: ${result.error || "Không có"}`
      );
    }

    fetchServices();
  </script>
</body>
</html>
